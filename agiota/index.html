<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agiota</title>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="js/firebase.js"></script>
  <link rel="stylesheet" href="css/index-style.css">

</head>
<body>
  <div id="logado" style="display: none;">
    <div class="container">
      <br> <!-- Adiciona a quebra de linha para separar o texto do campo de entrada -->
      <h1>Agiota do Pix</h1>
      <h2 id="h2-pagar">Ola, selecione o valor que quer receber</h2>
      <form id="pix-form">
        <label for="valor">Valor:</label>
        <input type="text" id="valor" name="valor" placeholder="Insira o valor   |   Ex: 10 ou 1.50 ou 10.00" required>
        <button type="submit">Enviar</button><br>
	    <img id="imageQRCode"  width="100" height="100" style="display: none;">
      </form>
    </div>
<div class="container-li">
  <div class="header-list">
    <div>
      <l1>Selecione a pessoa para emprestar dinheiro</h1>
      <ul id="emprestimo"></ul>
    </div>
    <div>
      <l2>Username da pessoa de quem vc esta devendo dinheiro</h2>
      <ul id="todevendo"></ul>
    </div>
    <div>
      <l3>Username da pessa de quem esta te devendo dinheiro</h3>
      <ul id="medeve"></ul>
    </div>
  </div>
</div>
  </div>

  <div id="deslogado" style="display: none;">
    <p>Para utilizar o site, você precisa estar logado.</p>
    <button id="registro">Registrar</button>
    <button id="login">login</button>
  </div>

  <script>
    const login = document.getElementById('login');
    const registro = document.getElementById('registro');
      
    login.addEventListener('click', () => {
      window.location.href = '/agiota/login';
    });

    registro.addEventListener('click', () => {
      window.location.href = '/agiota/registro';
    });    

firebase.auth().onAuthStateChanged(function(user) {
  const divDeslogado = document.getElementById('deslogado');
  const divLogado = document.getElementById('logado');

  if (user) {      
    divDeslogado.style.display = 'none';
    divLogado.style.display = 'block';

    
    var userId = user.uid;
    var userRef = firebase.database().ref('users/' + userId);

    userRef.once('value').then(function(snapshot) {
      var username = snapshot.val().username;
      var transaction = snapshot.child('inf/transaction').val();
      
      if (transaction && transaction.valor) {
  document.querySelector('#valor').style.display = 'none';
  document.querySelector('button[type="submit"]').style.display = 'none';
  document.querySelector('#valor').disabled = true;
  document.querySelector('label[for=valor]').style.display = 'none';
  document.querySelector('#h2-pagar').innerHTML = "Ola, " + username + "<br> escreva o valor que quer receber";

} else {
  document.querySelector('#valor').style.display = 'block';
  document.querySelector('button[type="submit"]').style.display = 'block';
  document.querySelector('#valor').disabled = false;
  document.querySelector('label[for=valor]').style.display = 'block';
  document.querySelector('#h2-pagar').innerHTML = "Ola, " + username + "<br>espere alguém enviar o dinheiro que você pediu.";

}
    }).catch(function(error) {
      console.log(error);
    });

  } else {
    divDeslogado.style.display = 'block';
    divLogado.style.display = 'none';      
  }
});


    var pixForm = document.querySelector('#pix-form');
    pixForm.addEventListener('submit', function(event) {
      event.preventDefault();

      const valorInput = document.querySelector('#valor').value;
      if (/^\d+\.\d{2}$/.test(valorInput)) { // Verifica se o valor está no formato correto
        const user = firebase.auth().currentUser;
        const userId = user.uid;
        const userRef = firebase.database().ref('users/' + userId + '/inf/transaction');
        
        userRef.set({
          valor: parseFloat(valorInput).toFixed(2)
        }).then(() => {
          console.log('Valor salvo com sucesso!');
        }).catch((error) => {
          console.log(error);
        });
      } else {
        alert('Valor inválido. O valor deve ser um número no formato xx.xx');
      }
    });

//Lista

var usersRef = firebase.database().ref('users');
  var emprestimo = document.getElementById("emprestimo");
  var medeve = document.getElementById("medeve");

  usersRef.orderByChild('username').on('value', function(snapshot) {
    emprestimo.innerHTML = '';
    medeve.innerHTML = '';

    snapshot.forEach(function(childSnapshot) {
      var username = childSnapshot.child('username').val();
      var recVal = childSnapshot.child('inf/transaction/valor').val();
      var aceita = childSnapshot.child('inf/transaction/aceita').val();
      var uid = childSnapshot.key;
      var meDeve = childSnapshot.child('inf/transaction/uid').val();

      if (recVal != null && recVal != undefined && /\d+/.test(recVal)) {
        if (!aceita) {
        var listItem = document.createElement("li");
        listItem.innerHTML = username + "|" + recVal;
        listItem.addEventListener('click', function() {
          firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
              var currentUserRef = firebase.database().ref('users/' + uid + '/inf/transaction');
              currentUserRef.update({
                uid: user.uid,
                aceita: true
              });
            }
          });
        });
        emprestimo.appendChild(listItem);
      }
     }

      firebase.auth().onAuthStateChanged(function(user) {
        if (user && meDeve === user.uid) {
          var listItem = document.createElement("li");
          listItem.innerHTML = username + "|" + recVal;
          medeve.appendChild(listItem);
        }
      });
    });

    if (emprestimo.children.length > 5) {
      emprestimo.style.height = "200px";
      emprestimo.style.overflow = "auto";
    }
    if (medeve.children.length > 5) {
      medeve.style.height = "200px";
      medeve.style.overflow = "auto";
    }
  });

  firebase.auth().onAuthStateChanged(function(user) {
  if (user) {
    var currentUserUid = user.uid;
    var toDevendoRef = firebase.database().ref('users/' + currentUserUid + '/inf/transaction');

    toDevendoRef.on('value', function(snapshot) {
      var toDevendoList = document.getElementById("todevendo");
      toDevendoList.innerHTML = '';

      snapshot.forEach(function(childSnapshot) {
        var uid = childSnapshot.val();
        if (uid.length === 28) {
          var usernameRef = firebase.database().ref('users/' + uid + '/username');
          var valorRef = firebase.database().ref('users/' + currentUserUid + '/inf/transaction/valor');
          
          usernameRef.once('value', function(usernameSnapshot) {
            valorRef.once('value', function(valorSnapshot) { // ajuste aqui!
              var username = usernameSnapshot.val();
              var valor = valorSnapshot.val();
              var listItem = document.createElement("li");
              listItem.innerHTML = username + " | " + valor; // Adiciona o valor ao elemento da lista
              toDevendoList.appendChild(listItem);
            });
          });
        }
      });
    });
  }
});

  </script>
</body>
</html>
