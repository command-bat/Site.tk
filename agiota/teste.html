<!DOCTYPE html>
<html>
<head>
	<title>Lista do Firebase</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 0;
		}

		h1, h2, h3 {
			background-color: #333;
			height: auto;
			max-height: 150px;
			width: auto;
			max-width: 350px;
			color: #fff;
			padding: 10px;
			margin: 0;
		}

		#emprestimo, #todevendo, #medeve {
			height: auto;
			max-height: 150px;
			width: auto;
			max-width: 350px;
			overflow-y: auto;
			padding: 0;
			margin: 0;
			list-style: none;
		}

		#emprestimo li, #todevendo li, #medeve li {
			padding: 10px;
			border-bottom: 1px solid #ccc;
			cursor: pointer;
		}
	</style>
</head>
<body>
  <h1>Selecione o username<br>para emprestar dinheiro</h1>
  <ul id="emprestimo"></ul>

  <h2>Username de quem esta<br>te devendo dinheiroU</h2>
  <ul id="todevendo"></ul>

  <h3>sername de quem vc esta<br>devendo dinheiro</h3>
  <ul id="medeve"></ul>

  <!-- Inclui o SDK do Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="js/firebase.js"></script>

  <script>
var usersRef = firebase.database().ref('users');
var currentUserUid;

// Consulta os usuários e exibe nas listas
firebase.auth().onAuthStateChanged(function(currentUser) {
  var emprestimo = document.getElementById("emprestimo");
  var todevendo = document.getElementById("todevendo");
  var medeve = document.getElementById("medeve");

  // Limpa as listas para evitar duplicidade de elementos
  emprestimo.innerHTML = '';
  todevendo.innerHTML = '';
  medeve.innerHTML = '';

  currentUserUid = currentUser ? currentUser.uid : null;

  var usernames = []; // array para armazenar usernames já adicionados

  usersRef.on('value', function(snapshot) {
    snapshot.forEach(function(childSnapshot) {
      var uid = childSnapshot.key;
      var username = childSnapshot.child('username').val();
      var receber = childSnapshot.child('inf/receber');

      if (receber.child('aceita').val() === false && receber.child('valor').val() !== null && /^\d+$/.test(receber.child('valor').val())) {
        var listItem = document.createElement("li");
        listItem.innerHTML = username + " | " + receber.child('valor').val();
        listItem.addEventListener('click', function() {
          var receberRef = receber.ref;
          receberRef.update({
            uid: currentUserUid,
            aceita: true
          }).then(function() {
            var currentUserRef = usersRef.child(currentUserUid);
            currentUserRef.child('inf/receber').child(uid).set(true);
          });
        });
        if (!usernames.includes(username)) { // verifica se o username já foi adicionado
          emprestimo.appendChild(listItem);
          usernames.push(username); // adiciona o username ao array
        }
      }

      if (currentUserUid && receber.child('uid').val() === currentUserUid) {
        var listItem = document.createElement("li");
        listItem.innerHTML = username + " | " + receber.child('valor').val();
        if (!usernames.includes(username)) { // verifica se o username já foi adicionado
          todevendo.appendChild(listItem);
          usernames.push(username); // adiciona o username ao array
        }
      }

      if (uid === currentUserUid) {
        receber.forEach(function(receberSnapshot) {
          var receberUid = receberSnapshot.key;
          if (receberUid !== 'aceita' && receberUid !== 'valor') {
            var valor = receberSnapshot.val();
            usersRef.child(receberUid).child('username').once('value', function(usernameSnapshot) {
              var username = usernameSnapshot.val();
              var listItem = document.createElement("li");
              listItem.innerHTML = username + " | " + valor + " | " + receberUid;
              if (!usernames.includes(username)) { // verifica se o username já foi adicionado
                medeve.appendChild(listItem);
                usernames.push(username); // adiciona o username ao array
              }
            });
          }
        });
      }
    });
  });

  // Remove os elementos das listas quando um usuário é removido
  usersRef.on('child_removed', function(snapshot) {
    var username = snapshot.child('username').val();
    var index = usernames.indexOf(username);
    if (index !== -1) {
      usernames.splice(index, 1);
    }
  });
});

</script>


</body>
</html>
