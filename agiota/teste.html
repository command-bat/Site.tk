<!DOCTYPE html>
<html>
<head>
	<title>Lista do Firebase</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 0;
		}

		h1, h2, h3 {
			background-color: #333;
			height: auto;
			max-height: 150px;
			width: auto;
			max-width: 350px;
			color: #fff;
			padding: 10px;
			margin: 0;
		}

		#emprestimo, #todevendo, #medeve {
			height: auto;
			max-height: 150px;
			width: auto;
			max-width: 350px;
			overflow-y: auto;
			padding: 0;
			margin: 0;
			list-style: none;
		}

		#emprestimo li, #todevendo li, #medeve li {
			padding: 10px;
			border-bottom: 1px solid #ccc;
			cursor: pointer;
		}
	</style>
</head>
<body>
  <h1>Selecione o username<br>para emprestar dinheiro</h1>
  <ul id="emprestimo"></ul>

  <h2>Username de quem esta<br>te devendo dinheiro</h2>
  <ul id="todevendo"></ul>

  <h3>Username de quem vc esta<br>devendo dinheiro</h3>
  <ul id="medeve"></ul>

  <!-- Inclui o SDK do Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="js/firebase.js"></script>

<script>
  var usersRef = firebase.database().ref('users');

  // Consulta os usuários e exibe na lista
  usersRef.orderByChild('username').on('value', function(snapshot) {
    var emprestimo = document.getElementById("emprestimo");
    var medeve = document.getElementById("medeve");
    emprestimo.innerHTML = ''; // Limpa a lista para evitar duplicidade de elementos
    medeve.innerHTML = ''; // Limpa a lista para evitar duplicidade de elementos
    snapshot.forEach(function(childSnapshot) {
      var username = childSnapshot.child('username').val();
      var recVal = childSnapshot.child('inf/receber/valor').val();
      var aceita = childSnapshot.child('inf/receber/aceita').val();
      var uid = childSnapshot.key;
      var meDeve = childSnapshot.child('inf/receber/uid').val();

      if (!aceita && recVal != null && recVal != undefined && /\d+/.test(recVal)) {
        var listItem = document.createElement("li");
        listItem.innerHTML = username + "|" + recVal;
        listItem.addEventListener('click', function() {
          firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
              var currentUserRef = firebase.database().ref('users/' + uid + '/inf/receber');
              var currentUserUid = user.uid;
              currentUserRef.update({
                uid: currentUserUid,
                aceita: true
              });
            }
          });
        });
        emprestimo.appendChild(listItem);
      }

      firebase.auth().onAuthStateChanged(function(user) {
        if (user && meDeve === user.uid) {
          var listItem = document.createElement("li");
          listItem.innerHTML = username + "|" + recVal;
          medeve.appendChild(listItem);
        }
      });
    });

    // Define a altura da lista de usuários com base na quantidade de itens
    if (emprestimo.children.length > 5) {
      emprestimo.style.height = "200px";
      emprestimo.style.overflow = "auto";
    }
    if (medeve.children.length > 5) {
      medeve.style.height = "200px";
      medeve.style.overflow = "auto";
    }
  });
  // obtém o usuário atualmente logado
  const user = firebase.auth().currentUser;

  // define o caminho para verificar se há usuários devedores
  const receberRef = database.ref(`users/${user.uid}/inf/receber`);
  
  // escuta por alterações no caminho definido
  receberRef.on('value', (snapshot) => {
    // limpa a lista de usuários devedores
    const toDevendoList = document.getElementById('todevendo');
    toDevendoList.innerHTML = '';
    
    // percorre todos os usuários que devem ao usuário atual
    snapshot.forEach((childSnapshot) => {
      const uid = childSnapshot.key;
      
      // verifica se o usuário que deve está registrado no sistema
      const userRef = database.ref(`users/${uid}`);
      userRef.once('value', (userSnapshot) => {
        const userData = userSnapshot.val();
        if (userData) {
          // adiciona o nome do usuário que deve na lista
          const li = document.createElement('li');
          li.textContent = userData.username;
          toDevendoList.appendChild(li);
        }
      });
    });
  });
</script>

</body>

</html>
