<!DOCTYPE html>
<html>
<head>
	<title>Lista do Firebase</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 0;
		}

		h1, h2, h3 {
			background-color: #333;
			height: auto;
			max-height: 150px;
			width: auto;
			max-width: 350px;
			color: #fff;
			padding: 10px;
			margin: 0;
		}

		#emprestimo, #todevendo, #medeve {
			height: auto;
			max-height: 150px;
			width: auto;
			max-width: 350px;
			overflow-y: auto;
			padding: 0;
			margin: 0;
			list-style: none;
		}

		#emprestimo li, #todevendo li, #medeve li {
			padding: 10px;
			border-bottom: 1px solid #ccc;
			cursor: pointer;
		}
	</style>
</head>
<body>
  <h1>Selecione o username<br>para emprestar dinheiro</h1>
  <ul id="emprestimo"></ul>

  <h2>Username de quem esta<br>te devendo dinheiro</h2>
  <ul id="todevendo"></ul>

  <h3>Username de quem vc esta<br>devendo dinheiro</h3>
  <ul id="medeve"></ul>

  <!-- Inclui o SDK do Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="js/firebase.js"></script>

 <script>
    var currentUserUid;

    firebase.auth().onAuthStateChanged(function(currentUser) {
      currentUserUid = currentUser ? currentUser.uid : null;

      // Lista de empréstimos
      var emprestimoRef = firebase.database().ref('users');
      emprestimoRef.on('value', function(snapshot) {
        var emprestimo = document.getElementById("emprestimo");
        emprestimo.innerHTML = '';
        snapshot.forEach(function(childSnapshot) {
          var uid = childSnapshot.key;
          var username = childSnapshot.child('inf/receber/username').val();
          var receber = childSnapshot.child('receber');
          if (!receber.child('aceita').val() && receber.child('valor').val() && /^\d+$/.test(receber.child('valor').val())) {
            var listItem = document.createElement("li");
            listItem.innerHTML = username + " | " + receber.child('valor').val();
            listItem.addEventListener('click', function() {
              receber.update({
                uid: currentUserUid,
                aceita: true
              }).then(function() {
                var currentUserRef = firebase.database().ref('users').child(currentUserUid);
                currentUserRef.child('receber').child(uid).set(true);
              });
            });
            emprestimo.appendChild(listItem);
          }
        });
      });

      // Lista de pessoas te devendo
      var todevendoRef = firebase.database().ref('users');
      todevendoRef.on('value', function(snapshot) {
        var todevendo = document.getElementById("todevendo");
        todevendo.innerHTML = '';
        snapshot.forEach(function(childSnapshot) {
          var uid = childSnapshot.key;
          var username = childSnapshot.child('username').val();
          var receber = childSnapshot.child('receber');
          if (receber.child('uid').val() === currentUserUid) {
            var listItem = document.createElement("li");
            listItem.innerHTML = username;
            listItem.addEventListener('click', function() {
              alert("Você emprestou " + receber.child('valor').val() + " para " + username);
            });
            todevendo.appendChild(listItem);
          }
        });
      });

      // Lista de pessoas que você está devendo
      var medeveRef = firebase.database().ref('users').child(currentUserUid).child('receber');
      medeveRef.on('value', function(snapshot) {
        var medeve = document.getElementById("medeve");
        medeve.innerHTML = '';
        snapshot.forEach(function(childSnapshot) {
          var uid = childSnapshot.key;
          var listItem = document.createElement("li");
          listItem.innerHTML = uid + " | " + childSnapshot.val();
          listItem.addEventListener('click', function() {
            alert("Você deve " + childSnapshot.val() + " para " + uid);
          });
          medeve.appendChild(listItem);
        });
      });
    });
  </script>
</body>
</html>
