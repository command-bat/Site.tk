<!DOCTYPE html>
<html>
<head>
	<title>Lista do Firebase</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 0;
		}

		h1, h2, h3 {
			background-color: #333;
			height: auto;
			max-height: 150px;
			width: auto;
			max-width: 350px;
			color: #fff;
			padding: 10px;
			margin: 0;
		}

		#emprestimo, #todevendo, #medeve {
			height: auto;
			max-height: 150px;
			width: auto;
			max-width: 350px;
			overflow-y: auto;
			padding: 0;
			margin: 0;
			list-style: none;
		}

		#emprestimo li, #todevendo li, #medeve li {
			padding: 10px;
			border-bottom: 1px solid #ccc;
			cursor: pointer;
		}
	</style>
</head>
<body>
  <h1>Selecione o username<br>para emprestar dinheiro</h1>
  <ul id="emprestimo"></ul>

  <h2>Username de quem esta<br>te devendo dinheiro</h2>
  <ul id="todevendo"></ul>

  <h3>Username de quem vc esta<br>devendo dinheiro</h3>
  <ul id="medeve"></ul>

  <!-- Inclui o SDK do Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="js/firebase.js"></script>

 <script>
const emprestimoList = document.getElementById('emprestimo');
const todevendoList = document.getElementById('todevendo');
const medeveList = document.getElementById('medeve');

const usersRef = firebase.database().ref('users');
const currentUser = firebase.auth().currentUser;

if (currentUser) {
  const currentUserUid = currentUser.uid;

  // Linha abaixo deve ser corrigida, pois 'receberRef' está sendo
  // definido com o mesmo valor que 'todevendoRef'
  const todevendoRef = usersRef.child(currentUserUid).child('receber');
  const receberRef = usersRef.child(currentUserUid).child('receber');

  const listaEmprestimo = {};

  // A variável abaixo deve ser 'receberRef', que foi definida corretamente
  receberRef.on('value', function(snapshot) {
    snapshot.forEach(function(childSnapshot) {
      const childData = childSnapshot.val();
      const receber = childData.receber;
      if (receber && receber.aceita === false && receber.uid === '') {
        const key = childSnapshot.key;
        if (!listaEmprestimo.hasOwnProperty(key)) {
          const listItem = document.createElement('li');
          listItem.innerText = `${childData.username}: ${receber.valor}`;
          listItem.id = `emprestimo-${key}`;
          emprestimoList.appendChild(listItem);

          listItem.addEventListener('click', function() {
            receber.aceita = true;
            receber.uid = currentUserUid;
            childSnapshot.ref.update({ receber });
          });

          listaEmprestimo[key] = true;
        }
      }
    });
  });

  // O código abaixo deve ser corrigido, pois está duplicando itens na lista
  // de "todevendo" e não está verificando se o item já existe
  todevendoRef.on('value', function(snapshot) {
    todevendoList.innerHTML = '';

    snapshot.forEach(function(childSnapshot) {
      const childData = childSnapshot.val();
      const childUid = childData.uid;
      if (childUid === currentUserUid) {
        const key = childSnapshot.key;
        const listItem = document.createElement('li');
        listItem.textContent = childData.username;
        listItem.id = `todevendo-${key}`;

        // Verifica se o item já existe na lista
        if (!todevendoList.contains(listItem)) {
          todevendoList.appendChild(listItem);

          listItem.addEventListener('click', function() {
            alert(`${childData.username} está te devendo R$${childData.valor}`);
          });
        }
      }
    });
  });

  // O código abaixo deve ser corrigido, pois está duplicando itens na lista
  // de "medeve" e não está verificando se o item já existe
  usersRef.on('value', function(snapshot) {
    medeveList.innerHTML = '';

    snapshot.forEach(function(childSnapshot) {
      const childData = childSnapshot.val();
      const receber = childData.receber;
      if (receber && receber.aceita === true && receber.uid === currentUserUid) {
        const key = childSnapshot.key;
        const listItem = document.createElement('li');
        listItem.textContent = childData.username;
        listItem.id = `medeve-${key}`;

        // Verifica se o item já existe na lista
        if (!medeveList.contains(listItem)) {
          medeveList.appendChild(listItem);
        }
      }
    });
  });
}

  </script>
</body>
</html>
