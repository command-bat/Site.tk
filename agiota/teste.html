<!DOCTYPE html>
<html>
<head>
	<title>Lista do Firebase</title>
	<style>


/* Estilos gerais */
body {
  font-family: 'Segoe UI', sans-serif;
  font-size: 16px;
  margin: 0;
  padding: 0;
  background-color: #f2f2f2;
}

.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 30px;
  box-sizing: border-box;
}

ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

/* Estilos específicos para o cabeçalho */
h1, h2, h3 {
  font-family: 'Poppins', sans-serif;
  font-size: 28px;
  font-weight: 600;
  margin: 0;
  padding: 0;
}

h1 {
  color: #202020;
}

h2 {
  color: #ffa500;
}

h3 {
  color: #00bfff;
}

/* Estilos para as listas */
#emprestimo li {
  background-color: #202020;
  color: #fff;
  padding: 10px;
  margin-bottom: 10px;
}

#todevendo li {
  background-color: #ffa500;
  color: #fff;
  padding: 10px;
  margin-bottom: 10px;
}

#medeve li {
  background-color: #00bfff;
  color: #fff;
  padding: 10px;
  margin-bottom: 10px;
}

/* Estilos para o layout dos cabeçalhos e listas */
.header-list {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
}

.header-list h1, .header-list h2, .header-list h3 {
  display: inline-block;
  width: 32%;
}

.header-list ul {
  width: 32%;
} 
	</style>
</head>
<body>
<div class="container">
  <h1>Selecione o username<br>para emprestar dinheiro</h1>
  <ul id="emprestimo"></ul>

  <h2>Username de quem vc esta<br>devendo dinheiro</h2>
  <ul id="todevendo"></ul>

  <h3>Username de quem esta<br>te devendo dinheiro</h3>
  <ul id="medeve"></ul>
</div>

<!-- Inclui o SDK do Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
<script src="js/firebase.js"></script>

<script>
  var usersRef = firebase.database().ref('users');
  var emprestimo = document.getElementById("emprestimo");
  var medeve = document.getElementById("medeve");

  usersRef.orderByChild('username').on('value', function(snapshot) {
    emprestimo.innerHTML = '';
    medeve.innerHTML = '';

    snapshot.forEach(function(childSnapshot) {
      var username = childSnapshot.child('username').val();
      var recVal = childSnapshot.child('inf/transaction/valor').val();
      var aceita = childSnapshot.child('inf/transaction/aceita').val();
      var uid = childSnapshot.key;
      var meDeve = childSnapshot.child('inf/transaction/uid').val();

      if (!aceita && recVal != null && recVal != undefined && /\d+/.test(recVal)) {
        var listItem = document.createElement("li");
        listItem.innerHTML = username + "|" + recVal;
        listItem.addEventListener('click', function() {
          firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
              var currentUserRef = firebase.database().ref('users/' + uid + '/inf/transaction');
              currentUserRef.update({
                uid: user.uid,
                aceita: true
              });
            }
          });
        });
        emprestimo.appendChild(listItem);
      }

      firebase.auth().onAuthStateChanged(function(user) {
        if (user && meDeve === user.uid) {
          var listItem = document.createElement("li");
          listItem.innerHTML = username + "|" + recVal;
          medeve.appendChild(listItem);
        }
      });
    });

    if (emprestimo.children.length > 5) {
      emprestimo.style.height = "200px";
      emprestimo.style.overflow = "auto";
    }
    if (medeve.children.length > 5) {
      medeve.style.height = "200px";
      medeve.style.overflow = "auto";
    }
  });

  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      var currentUserUid = user.uid;
      var toDevendoRef = firebase.database().ref('users/' + currentUserUid + '/inf/transaction');

      toDevendoRef.on('value', function(snapshot) {
        var toDevendoList = document.getElementById("todevendo");
        toDevendoList.innerHTML = '';

        snapshot.forEach(function(childSnapshot) {
          var uid = childSnapshot.val();
          if (uid.length === 28) {
          var usernameRef = firebase.database().ref('users/' + uid + '/username');
		
          usernameRef.once('value', function(usernameSnapshot) {
            var username = usernameSnapshot.val();
            var listItem = document.createElement("li");
            listItem.innerHTML = username;
            toDevendoList.appendChild(listItem);
          });
}
        });
      });
    }
  });

</script>

</body>

</html>
